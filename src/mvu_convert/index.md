# MVU变量转换器功能说明文档

## 概述

MVU变量转换器是一个用于将旧版JSON格式转换为新版JSON结构和YAML描述的工具。该工具支持在SillyTavern环境中运行，提供完整的变量转换、编辑和赋值功能。

**版本**: 8.042 (测试接口版)  
**作者**: LiuLi 25_08_05  
**最后更新**: 2025-08-05

## 主要功能

### 1. 变量转换功能

- **旧版JSON到新版JSON转换**: 将包含`[数据, 描述]`格式的旧版JSON转换为纯数据结构
- **YAML描述生成**: 自动生成对应的YAML格式描述文档
- **可增删列表处理**: 智能识别和处理可增删列表结构
- **递归可增删列表处理**: 支持深层嵌套的可增删列表结构

### 2. 界面功能

#### 2.1 主界面元素

**标题栏**

- 显示当前版本号和构建时间
- 右上角关闭按钮 (×)

**输入区域**

- **输入框**: 用于粘贴或输入旧版JSON数据
- **一键复制按钮**: 快速复制输入框内容
- **编辑按钮 (✏️)**: 打开编辑弹窗修改输入内容

**按钮栏**

- **赋值最新楼层+Chat变量**: 将转换结果赋值给最新楼层的stat_data变量和Chat变量
- **开始转换**: 执行JSON到新版JSON和YAML的转换
- **清空输入**: 清空输入框内容
- **世界书同步复选框**: 选择是否同时更新世界书
- **强制刷新**: 强制刷新模块（隐藏状态）
- **关闭**: 关闭转换器弹窗

**输出区域**

- **新版JSON结构**: 显示转换后的JSON结构
  - 复制按钮: 复制JSON内容
  - 编辑按钮 (✏️): 编辑JSON内容
- **变量描述 (YAML)**: 显示生成的YAML描述
  - 隐藏代码部分复选框: 简化YAML输出
  - 复制按钮: 复制YAML内容
  - 编辑按钮 (✏️): 编辑YAML内容

**状态栏**

- 显示操作状态和错误信息
- 支持错误状态显示

#### 2.2 编辑弹窗

**编辑弹窗功能**

- **标题**: 显示当前编辑的内容类型
- **编辑区域**: 大型文本编辑框，支持多行编辑
- **保存按钮**: 保存编辑内容并关闭弹窗
- **取消按钮**: 取消编辑并关闭弹窗
- **关闭按钮 (×)**: 关闭编辑弹窗

### 3. 核心转换逻辑

#### 3.1 数组格式识别

支持多种数组格式：

- `[数据, 描述]`: 基础格式
- `[[数据, 描述], 更新说明]`: 嵌套格式
- `[数据, 描述, 额外信息]`: 扩展格式
- `[对象, 描述]`: 对象格式
- `[数组, 描述]`: 数组格式

#### 3.2 可增删列表处理

- **识别规则**: 基于`$meta.extensible`属性和结构模式识别
- **处理逻辑**: 保留`$meta`属性，删除实例数据，生成EJS模板
- **变量名生成**: 支持中文和英文变量名

#### 3.3 递归可增删列表处理

- **识别规则**: 基于`$meta.recursiveExtensible`属性
- **处理逻辑**: 保留所有子项，生成动态EJS模板
- **模板去重**: 自动识别和合并相似结构

### 4. API集成

#### 4.1 SillyTavern API

- `getLastMessageId()`: 获取最新消息ID
- `getVariables()`: 获取消息变量
- `replaceVariables()`: 替换变量
- `insertOrAssignVariables()`: 插入或赋值变量
- `getCurrentCharPrimaryLorebook()`: 获取角色主要世界书
- `getLorebookEntries()`: 获取世界书条目
- `replaceLorebookEntries()`: 替换世界书条目

#### 4.2 世界书同步

- **JSON条目**: `[InitVar]` - 存储转换后的JSON结构
- **Markdown条目**: `[InitVar_YAML]` - 存储YAML描述
- **同步逻辑**: 基于条目注释匹配，避免关键词丢失

### 5. 错误处理

#### 5.1 输入验证

- JSON格式验证
- 数据结构验证
- 必填字段检查

#### 5.2 错误恢复

- 自动重试机制
- 降级处理策略
- 用户友好的错误提示

### 6. 性能优化

#### 6.1 缓存机制

- 转换结果缓存
- 结构数据缓存
- 完整数据缓存

#### 6.2 内存管理

- 按需加载模块
- 自动卸载机制
- 事件监听器清理

### 7. 测试接口

#### 7.1 测试类型

- **转换测试**: 验证JSON转换逻辑
- **UI测试**: 验证界面功能
- **边界测试**: 测试异常情况
- **集成测试**: 测试完整流程

#### 7.2 测试用例

- 基础转换案例
- 背包列表结构转换
- 复杂嵌套结构转换
- 空输入处理
- 无效JSON处理

### 8. 使用说明

#### 8.1 基本使用流程

1. 点击"MVU变量转化器"按钮打开弹窗
2. 在输入框中粘贴旧版JSON数据
3. 点击"开始转换"执行转换
4. 查看转换结果（新版JSON结构和YAML描述）
5. 使用复制按钮复制结果
6. 可选择赋值到最新楼层或更新世界书

#### 8.2 高级功能

- **编辑功能**: 点击编辑按钮修改任何内容
- **世界书同步**: 勾选复选框自动更新世界书
- **变量赋值**: 一键赋值到最新楼层和Chat变量

### 9. 注意事项

#### 9.1 环境要求

- 必须在SillyTavern环境中运行
- 需要支持相关API函数
- 建议使用现代浏览器

#### 9.2 数据格式

- 输入必须是有效的JSON格式
- 支持嵌套对象和数组结构
- 建议使用UTF-8编码

#### 9.3 性能考虑

- 大型数据结构可能需要较长处理时间
- 建议分批处理大量数据
- 定期清理缓存以释放内存

### 10. 术语定义

#### 10.1 核心概念

**旧版Json数据**

- **定义**: 数据中会出现采用 `[值, 描述]` 格式的数据结构
- **格式示例**: `[16, '当前角色年龄']`、`[100, '范围[0-100]的体力值']`
- **特点**: 第一个元素为实际数据值，第二个元素为字符串描述
- **用途**: 用于标识需要转换的旧版数据格式

**新版Json数据**

- **定义**: 数据中会出现只有值的数据结构，没有再新建数组结构来存储描述
- **标识**: `{"NPC":{"艾略特":{"身体状态":{"年龄":16},"关键器官状态":{"性器官群":"暂无反应"},"心理状态":{"与User关系值":99},"衣着":{"上衣":"无"}},"伊桑":{"身体状态":{"年龄":17},"关键器官状态":{"性器官群":"暂无反应"},"心理状态":{"与User关系值":100},"衣着":{"上衣":"无"}}}}`

**新版Json数据结构**

- **定义**: 其通常结构和<新版Json数据>的默认结构和值都是一致的，除了可增删列表结构，其不会缓存实例数据，仅留存$meta: extensible/recursiveExtensible=true
- **标识**: `{"NPC":{"$meta": {"extensible": true}}}`

**可增删列表结构（统一概念）**

- **定义**: 支持动态添加、删除元素的数据结构，包括单层和递归扩展
- **识别条件**:
  1. 明确标识：存在 `$meta.extensible` 或 `$meta.recursiveExtensible` 属性
  2. 智能识别：80%以上的子对象具有相同字段结构 **且** 80%以上包含旧版Json数据结构
- **处理方式**: 统一转换为EJS模板格式，支持动态遍历
- **概念合一**: 8.3版本实现概念合一，`extensible`和`recursiveExtensible`使用相同的处理逻辑
- **向后兼容**: 保持对两种标识的支持，但内部处理逻辑统一

#### 10.2 转换流程

**JSON转换**

- **输入**: 包含旧版Json数据结构的原始JSON
- **输出**: 纯数据结构的新版JSON（保留 `$meta` 属性）
- **过程**: 提取 `[值, 描述]` 中的值，移除描述信息

**YAML转换**

- **输入**: 原始JSON结构
- **输出**: EJS模板格式的YAML描述
- **特点**: 包含类型注释、字段描述、动态遍历逻辑
- **重要**: 递归可增删列表与普通可增删列表使用相同的EJS模板生成方式

### 11. 版本历史

#### 8.3 (概念合一版)

- **重要改进**: 实现可增删列表结构和递归可增删列表结构概念合一
  - 统一处理逻辑，`handleRecursiveExtensibleList`复用`handleExtensibleList`的处理方式
  - 减少代码重复，两个概念本质上生成相同的EJS模板格式
  - 保持向后兼容，`$meta.extensible`和`$meta.recursiveExtensible`都正常工作
- **设计优化**: 简化架构设计
  - 递归可增删列表本质上与普通可增删列表相同，都生成EJS模板格式
  - 统一处理策略，根据实际需求决定是否保存数据
  - 减少维护成本，避免功能重复
- **测试验证**: 添加概念合一测试案例
  - 验证相同输入结构下，extensible和recursiveExtensible产生相同输出
  - 确认概念合一的可行性和正确性
  - 保持所有现有功能正常工作

#### 8.043 (递归处理统一版)

- **重要修复**: 统一递归可增删列表处理方式
  - 修改`handleRecursiveExtensibleList`函数，遵循可增删列表结构的处理方式
  - 递归可增删列表现在生成完整的EJS模板，支持动态遍历
  - 移除特殊化处理，确保与术语定义一致
- **改进**: 优化YAML模板生成
  - 生成标准的EJS动态遍历逻辑（`<%_`, `forEach`, `_%>`）
  - 支持嵌套对象结构的递归模板生成
  - 简化对象描述格式（`# object`）
- **测试**: 验证旧版JSON到新版JSON转换功能
  - 确认递归可增删列表正确转换为EJS模板格式
  - 保持JSON输出的$meta属性完整性

#### 8.042 (测试接口版)

- 添加完整的测试接口
- 修复旧版JSON转换失败问题
- 修改标题为"新版JSON结构"
- 增强日志输出和错误处理
- **新增**: 增强可增删列表结构智能识别
  - 实现80%字段相同阈值的识别逻辑
  - 增加旧版Json数据结构([值,描述])检测
  - 支持无$meta字段的自动识别
- **新增**: 更新EJS模板格式的YAML输出
- **新增**: 添加术语定义和说明文档

#### 8.041 (编辑功能版)

- 添加编辑功能
- 支持手动编辑变量结构和描述
- 提供弹窗编辑界面

#### 8.040 (赋值修复版)

- 修复赋值API调用
- 简化逻辑，直接使用replaceVariables和insertOrAssignVariables

#### 8.039 (双版本数据版)

- 创建两个版本的数据
- 结构版本用于显示（删除实例）
- 完整版本用于赋值（保留实例）

### 11. 技术支持

#### 11.1 常见问题

- **转换失败**: 检查JSON格式是否正确
- **赋值失败**: 确认SillyTavern环境正常
- **世界书同步失败**: 检查世界书条目是否存在

#### 11.2 调试信息

- 控制台输出详细的处理日志
- 包含版本信息和构建时间
- 提供错误堆栈信息

#### 11.3 联系方式

- 作者: LiuLi 25_08_05
- 项目: MVU变量转换器
- 版本: 8.043 (递归处理统一版)

---

*本文档随版本更新，请确保使用最新版本的功能说明。*
